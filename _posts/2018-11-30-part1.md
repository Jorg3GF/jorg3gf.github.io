---
title: "Challenge"
date: 2018-11-30
tags: [data cleaning]
excerpt: "test"
---

# PART 1  

## ETL  

Both *issues* and *issuesHistory* csv files will be cleaned and loaded into Snowflake, so any business user can properly investigate them.

```r
library(readr)
issues <- read.csv("~/Desktop/Tests/Outsystems/issues.csv")
head(issues)
```

```
##   Project      Key           Created              Status  Type
## 1     TAL TAL-1044 10/05/2018, 10:52 Waiting UX / Design Story
## 2     TAL TAL-1043 04/07/2018, 16:06               To Do Story
## 3     TAL TAL-1042 04/07/2018, 15:11         In Progress Story
## 4     TAL TAL-1041 04/07/2018, 15:09               To Do Story
## 5     TAL TAL-1040 04/07/2018, 08:00               To Do Story
## 6     TAL TAL-1039 04/07/2018, 07:52               To Do Story
```
Starting with the *issues.csv* file... Does it have any missing data?

```r
sum(is.na(issues))
```

```
## [1] 0
```

```r
length(duplicated(issues)[duplicated(issues)=="TRUE"])
```

```
## [1] 0
```
There are no missing values and all observations are unique.
But dates in **Created** are not in the right format, so that needs to be amended.

```r
issues$Created <- gsub(",","",issues$Created)
issues$Created <- as.POSIXct(issues$Created, format = "%d/%m/%Y %H:%M", tz="GMT")
issues$Key <- as.character(issues$Key)
str(issues)
```

```
## 'data.frame':	4247 obs. of  5 variables:
##  $ Project: Factor w/ 5 levels "CVAL","DFO","DW",..: 5 5 5 5 5 5 5 5 5 5 ...
##  $ Key    : chr  "TAL-1044" "TAL-1043" "TAL-1042" "TAL-1041" ...
##  $ Created: POSIXct, format: "2018-05-10 10:52:00" "2018-07-04 16:06:00" ...
##  $ Status : Factor w/ 14 levels "Blocked","Candidate - Estimate Requested",..: 14 13 6 13 13 13 13 7 5 9 ...
##  $ Type   : Factor w/ 11 levels "Bug","Bug - Sub-Task",..: 8 8 8 8 8 8 8 1 1 1 ...
```
In total, there were 4247 issues created between 2016-03-23 14:36:00 and 2018-07-06 11:03:00. And the *issues.csv* file is ready to be loaded into Snowflake.


```r
write.csv(issues, "~/Desktop/issues.csv", row.names = FALSE, quote = FALSE)
```

Now let's take a look at the *issuesHistory.csv* file and see what kind of cleaning it requires. As the file was being read into R, I identified a typo in row number 11918 which prevented it to proceed properly. So, I fixed it manually, saved it as *issuesHistory.xlsx* and used the *read_xlsx* function from the *readxl* library.

```r
library(readxl)
history <- read_xlsx("~/Desktop/Tests/Outsystems/issuesHistory.xlsx")
history <- as.data.frame(history)
```
Dates in **Created** have the same format problem as in the *issues* file, so will treat them the same way.

```r
history$Created <- gsub(",","",history$Created)
history$Created <- as.POSIXct(history$Created, format = "%d/%m/%Y %H:%M", tz="GMT")
str(history)
```

```
## 'data.frame':	18011 obs. of  10 variables:
##  $ Issue      : chr  "TAL-1044" "TAL-1044" "TAL-1044" "TAL-1042" ...
##  $ History Id : num  1220713 1220710 1220545 1218163 1218162 ...
##  $ Author     : chr  "ase" "ase" "ase" "paulo.junior" ...
##  $ Created    : POSIXct, format: "2018-07-05 12:09:00" "2018-07-05 12:09:00" ...
##  $ Field      : chr  "status" "status" "status" "status" ...
##  $ Type       : chr  "jira" "jira" "jira" "jira" ...
##  $ From       : num  10001 12400 10001 10401 14800 ...
##  $ From String: chr  "To Do" "Done" "To Do" "Ready" ...
##  $ To         : num  13900 10001 12400 11702 10401 ...
##  $ To String  : chr  "Waiting UX / Design" "To Do" "Done" "In Progress" ...
```
Now let's investigate the dataset further. Does it have missing values?

```r
sum(is.na(history))
```

```
## [1] 19
```

```r
history[rowSums(is.na(history)) > 0, colSums(is.na(history)) > 0]
```

```
##       History Id             Created  Field             Type  From
## 11918    1008968 2018-01-30 16:32:00 status jirimate Request 10401
## 11919    1008967 2018-01-30 16:32:00 status             jira 10001
## 13167         NA                <NA>   <NA>             <NA>    NA
## 13993         NA                <NA>   <NA>             <NA>    NA
##       From String   To To String
## 11918       Ready   NA      <NA>
## 11919       To Do 1480      <NA>
## 13167        <NA>   NA      <NA>
## 13993        <NA>   NA      <NA>
```
This time we have 19 missing values across 4 observations. The first two rows belong to *Issue DFO-444*. Allow me to check all its records as we might find a way to fill in those NAs.

```r
history[history$Issue=="DFO-444",]
```

```
##         Issue History Id Author             Created  Field
## 11917 DFO-444    1019807    cia 2018-02-06 19:40:00 status
## 11918 DFO-444    1008968    epe 2018-01-30 16:32:00 status
## 11919 DFO-444    1008967    epe 2018-01-30 16:32:00 status
## 13691 DFO-444    1019807    cia 2018-02-06 19:40:00 status
## 13692 DFO-444    1008970    epe 2018-01-30 16:32:00 status
## 13693 DFO-444    1008969    epe 2018-01-30 16:32:00 status
## 13694 DFO-444    1008968    epe 2018-01-30 16:32:00 status
## 13695 DFO-444    1008967    epe 2018-01-30 16:32:00 status
##                   Type  From                                From String
## 11917             jira 14000                      Development Completed
## 11918 jirimate Request 10401                                      Ready
## 11919             jira 10001                                      To Do
## 13691             jira 14000                      Development Completed
## 13692             jira 11702                                In Progress
## 13693             jira 10401                                      Ready
## 13694             jira 14800 Kanban Candidate - Urgent Estimate Request
## 13695             jira 10001                                      To Do
##          To                                  To String
## 11917 12400                                       Done
## 11918    NA                                       <NA>
## 11919  1480                                       <NA>
## 13691 12400                                       Done
## 13692 14000                      Development Completed
## 13693 11702                                In Progress
## 13694 10401                                      Ready
## 13695 14800 Kanban Candidate - Urgent Estimate Request
```
By coincidence, the rows which have NAs are duplicated, as their **History Id** repeats. Also, the last two rows with missing values are not relevant either, so we can drop them all.

```r
history <- na.omit(history)
sum(is.na(history))
```

```
## [1] 0
```

```r
length(duplicated(history)[duplicated(history)=="TRUE"])
```

```
## [1] 1
```
Apparenty, still have a duplicated value. And once again, belongs to *Issue DFO-444*. Let's get rid of it.

```r
history[duplicated(history),]
```

```
##         Issue History Id Author             Created  Field Type  From
## 13691 DFO-444    1019807    cia 2018-02-06 19:40:00 status jira 14000
##                 From String    To To String
## 13691 Development Completed 12400      Done
```

```r
history <- unique(history)
length(unique(history$`History Id`))
```

```
## [1] 18006
```
But I am not too sure about all these unique rows... There are observations where **Issues' Status** don't change, yet get a different **History Id**.

```r
head(history[history$From==history$To,])
```

```
##        Issue History Id       Author             Created  Field Type  From
## 389  TAL-948    1191608 paulo.junior 2018-06-14 15:17:00 status jira 10001
## 442  TAL-938    1166546          rcp 2018-05-28 14:58:00 status jira 12400
## 596  TAL-907    1164729          ase 2018-05-26 01:02:00 status jira 10001
## 658  TAL-894    1185887          ase 2018-06-11 11:30:00 status jira 10001
## 811  TAL-869    1209543          rcp 2018-06-27 13:55:00 status jira 12400
## 1016 TAL-838    1214550 paulo.junior 2018-07-02 15:23:00 status jira 10001
##      From String    To To String
## 389        To Do 10001     To Do
## 442         Done 12400      Done
## 596        To Do 10001     To Do
## 658        To Do 10001     To Do
## 811         Done 12400      Done
## 1016       To Do 10001     To Do
```
It doesn't feel right to me. So, I am going to get rid of these rows too.

```r
history <- history[history$From!=history$To,]
```
In the end, we have 17879 observations for *issuesHistory*. Although it looks like it is ready to be loaded into Snowflake, I don't find it very friendly to have different names for the same **From** or **To** IDs, as we can see below:

```r
table(history[history$From=='10401',]$From,history[history$From=='10401',]$`From String`)
```

```
##        
##         Estimated & Ready Ready READY
##   10401                60  2177   112
```
For example, for *Issue 10401* we see three different **From Strings**: *Estimated & Ready*, *READY* and *Ready*. Does this happen very often? Below there is a table counting the number of different names each **From** ID has:

```r
aggregate(data=history, `From String`~From, function(x) length(unique(x)))
```

```
##      From From String
## 1       1           1
## 2       4           1
## 3   10001           2
## 4   10400           1
## 5   10401           3
## 6   10403           1
## 7   10700           1
## 8   11201           1
## 9   11702           2
## 10  11900           1
## 11  11901           1
## 12  12102           1
## 13  12400           1
## 14  13500           1
## 15  13700           1
## 16  13800           2
## 17  13900           2
## 18  13901           1
## 19  14000           1
## 20  14001           1
## 21  14100           1
## 22  14200           1
## 23  14800           1
## 24  14909           1
## 25 185979           1
```
It could be OKish to keep it like this, as a business user can always filter or select records by their **From** or **To** IDs, but I guess would be better to standardize it - I will use the most popular names.
However, because they might contain relevant information (such as *PO Accepted* or *Estimated*), I will save all their former names into two new columns: **From Comments** and **To Comments**.

```r
library(dplyr)
#Creation of comments columns
history$`From Comments` <- history$`From String`
history$`To Comments` <- history$`To String`

#Replacement of From/To Strings by their most popular names
history <- history %>% group_by(From) %>% mutate (`From String`=names(which.max(table(`From String`)))) %>% ungroup()
history <- history %>% group_by(To) %>% mutate (`To String`=names(which.max(table(`To String`)))) %>% ungroup()

#If names are the same, there's no need to add any comment. Otherwise, let's keep this information
history$`From Comments` <- ifelse(history$`From Comments`==history$`From String`,"No Comments",history$`From Comments`)
history$`To Comments` <- ifelse(history$`To Comments`==history$`To String`,"No Comments",history$`To Comments`)

head(as.data.frame(history))
```

```
##      Issue History Id       Author             Created  Field Type  From
## 1 TAL-1044    1220713          ase 2018-07-05 12:09:00 status jira 10001
## 2 TAL-1044    1220710          ase 2018-07-05 12:09:00 status jira 12400
## 3 TAL-1044    1220545          ase 2018-07-05 12:07:00 status jira 10001
## 4 TAL-1042    1218163 paulo.junior 2018-07-04 15:34:00 status jira 10401
## 5 TAL-1042    1218162 paulo.junior 2018-07-04 15:34:00 status jira 14800
## 6 TAL-1042    1218113          ase 2018-07-04 15:11:00 status jira 10001
##                                  From String    To
## 1                                      To Do 13900
## 2                                       Done 10001
## 3                                      To Do 12400
## 4                                      Ready 11702
## 5 Kanban Candidate - Urgent Estimate Request 10401
## 6                                      To Do 14800
##                                    To String From Comments To Comments
## 1                        Waiting UX / Design   No Comments No Comments
## 2                                      To Do   No Comments No Comments
## 3                                       Done   No Comments No Comments
## 4                                In Progress   No Comments No Comments
## 5                                      Ready   No Comments No Comments
## 6 Kanban Candidate - Urgent Estimate Request   No Comments No Comments
```

The files are cleaned and ready to be loaded into Snowflake for further analysis and business use.


```r
write.csv(history, "~/Desktop/history.csv", row.names = FALSE, quote = FALSE)
```
